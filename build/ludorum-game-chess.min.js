//! ludorum-game-chess 0.0.1

(function(t){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum","chess.js"],t):"object"==typeof exports&&module.exports?module.exports=t(require("creatartis-base"),require("sermat"),require("ludorum"),require("chess.js")):this["ludorum-game-chess"]=t(this.base,this.Sermat,this.ludorum,this.chess)}).call(this,function t(n,r,e){"use strict";var i=n.declare,o=(n.obj,n.copy,n.raise,n.raiseIf),s=n.Iterable,a=n.iterable,u=e.Game,c=e.utils.Checkerboard,h=(e.utils.CheckerboardFromString,e.players.UserInterface,{__package__:"ludorum-game-connect4",__name__:"ludorum_game_connect4",__init__:t,__dependencies__:[n,r,e],__SERMAT__:{include:[n,e]}}),l=(h.ChessBoard=i({height:8,width:8,constructor:function(t){this.constructor.arrayToBoard(t,this)},"static arrayToBoard":function(t,n){return n=n||{},"RNBQKBNRPPPPPPPPpppppppprnbqkbnr".split("").forEach(function(r,e){var i=t[e];if(i<255){var o=7&i,s=(56&i)>>3,a=r.toUpperCase();n[o+","+s]={player:a===r?0:1,kind:a,row:o,col:s,flags:flags,index:e}}}),n},toArray:function(){return this.constructor.boardToArray(this)},"static boardToArray":function(t,n){var r;for(var e in n=n||new Uint8Array(32).fill(255),t)n[(r=t[e]).index]=(7&r.col)<<3|7&r.row;return n},isValidPosition:function(t){var n=t[0],r=t[1];return n>=0&&n<this.width&&r>=0&&r<this.height},isEmptyPosition:function(t){return this.isValidPosition(t)&&!this.hasOwnProperty(t[0]+","+t[1])},isPlayersPosition:function(t,n){return this.isValidPosition(t)&&this.hasOwnProperty(t[0]+","+t[1])&&this[t[0]+","+t[1]].player===n},canMoveTo:function(t,n){return this.isValidPosition(t)&&(!this.hasOwnProperty(t[0]+","+t[1])||this[t[0]+","+t[1]].player!==n)},canCaptureAt:function(t,n){return this.isValidPosition(t)&&this.hasOwnProperty(t[0]+","+t[1])&&this[t[0]+","+t[1]].player!==n},forward:function(t){return 0===t?1:-1},rank:function(t,n){return 0===n?t-1:this.height-t},toString:function(){var t=this;return s.range(8).map(function(n){return s.range(8).map(function(r){return piece=t[n+","+r],piece?0===piece.player?piece.kind.toUpperCase():piece.kind.toLowerCase():"."}).join("")}).join("\n")},"dual encodeMove":function(t,n,r,e,i){return((((i&=7)<<3|(t&=7))<<3|(n&=7))<<3|(r&=7))<<3|(e&=7)},"dual decodeMove":function(t){return promotion=t>>10&7,fromRow=t>>9&7,fromCol=t>>6&7,toRow=t>>3&7,toCol=7&t,[[fromRow,fromCol],[toRow,toCol],flags,promotion]},moves_Pawn:function(t){var n=this.forward(t.player),r=[],e=t.row+n;return this.isEmptyPosition([e,t.col])&&r.push(this.encodeMove(t.row,t.col,e,t.col)),t.row===this.rank(2,t.player)&&this.isEmptyPosition([t.row+2*n,t.col])&&r.push(this.encodeMove(t.row,t.col,t.row+2*n,t.col)),this.canCaptureAt([e,t.col-1],t.player)&&r.push(this.encodeMove(t.row,t.col,e,t.col-1)),this.canCaptureAt([e,t.col+1],t.player)&&r.push(this.encodeMove(t.row,t.col,e,t.col+1)),r},moves_Knight:function(t){var n=this,r=t.row,e=t.col;return a([[2,1],[1,2],[2,-1],[-1,2],[-2,-1],[-1,-2],[-2,1],[1,-2]]).filterApply(function(i,o){return n.canMoveTo([r+i,e+o],t.player)},function(t,i){return n.encodeMove(r,e,r+t,e+i)})},moves_Bishop:function(t){var n=this,r=t.row,e=t.col;return a(n.walks([r,e],c.DIRECTIONS.DIAGONAL)).map(function(i){var o=!0;return i.tail().takeWhile(function(r){var e=o&&n.canMoveTo(r,t.player);return o=o&&n.isEmptyPosition(r),e}).map(function(t){return n.encodeMove(r,e,t[0],t[1])})}).flatten()},moves_Rook:function(t){var n=this,r=t.row,e=t.col;return a(n.walks([r,e],c.DIRECTIONS.ORTHOGONAL)).map(function(i){var o=!0;return i.tail().takeWhile(function(r){var e=o&&n.canMoveTo(r,t.player);return o=o&&n.isEmptyPosition(r),e}).map(function(t){return n.encodeMove(r,e,t[0],t[1])})}).flatten()},moves_Queen:function(t){var n=this,r=t.row,e=t.col;return a(n.walks([r,e],c.DIRECTIONS.EVERY)).map(function(i){var o=!0;return i.tail().takeWhile(function(r){var e=o&&n.canMoveTo(r,t.player);return o=o&&n.isEmptyPosition(r),e}).map(function(t){return n.encodeMove(r,e,t[0],t[1])})}).flatten()},moves_King:function(t){var n=this,r=t.row,e=t.col;return a(c.DIRECTIONS.EVERY).filterApply(function(i,o){return n.canMoveTo([r+i,e+o],t.player)},function(t,i){return n.encodeMove(r,e,r+t,r+i)})},apply:function(t){var n=(t="number"==typeof t?this.decodeMove(t):t)[0][0],r=t[0][1],e=t[1][0],i=t[1][1],o=0|t[2],s=0|t[3];return piece=board[n+","+r],delete this[n+","+r],this[e+","+i]=piece,piece.flags=o,s>0&&(piece.kind="PNBRQ".charAt(s)),this}}),h.Chess=i(u,{name:"Chess",players:["White","Black"],constructor:function t(n){n=n||{},u.call(this,n.activePlayer||this.players[0]),this.board=n.board?"string"==typeof n.board?t.boardFromFEN(n.board):n.board:this.initialBoard(),this.castling=n.castling||"KQkq",this.enPassant=n.enPassant,this.halfMoves=0|n.halfMoves,this.fullMoves=Math.max(0|n.fullMoves,1);var r=this;this.pieces=a(this.players).map(function(t){return[t,a(r.kinds).mapApply(function(t,n){return[t,[]]}).toObject()]}).toObject(),a(this.board.pieces).forEachApply(function(t,n){r.pieces[n.player][n.name].push(n)})},moves:function(){if(!this.hasOwnProperty("__moves__")){var t=this,r=this.board,e=this.activePlayer();this.pieces[e].King[0];if(this.checkMoves=[],!(this.checkMoves.length<1))throw new Error("Do not know what to do when in check!");this.__moves__=n.obj(e,a(this.pieces[e]).mapApply(function(t,n){return n}).flatten().map(function(n){return n.moves(t,r)}).flatten().toArray())}return this.__moves__},next:function(t,n,r){o(n,"Haps are not required (given ",n,")!");var e=this.activePlayer(),i=t[e],s=this.board.square(i[1]),a={activePlayer:this.opponent(),board:s.next(this,this.board,i),castling:this.castling,enPassant:null,halfMoves:this.halfMoves,fullMoves:this.fullMoves+("Black"===e?1:0)};return r?(this.constructor(a),this):new this.constructor(a)},result:function(){return this.moves()[this.activePlayer()]?null:this.checkMoves.length>0?this.defeat():this.draw()},"static __SERMAT__":{identifier:"Chess",serializer:function(t){return[t.toFEN()]},materializer:function(t,n){return n?l.fromFEN(n[0]):null}},clone:function(){return l.fromFEN(this.toFEN())},"dual coordFromString":function(t){return[+t.charAt(1)+1,t.charCodeAt(0)-"a".charCodeAt(0)]},"dual coordToString":function(t){return String.fromCharCode("a".charCodeAt(0)+t[1])+(t[0]+1)},toString:function(){return this.toFEN()},toFEN:function(){var t=this.board,n=t.horizontals().map(function(n){var r="",e=0;return n.forEach(function(n){var i=t.square(n);i?(e>0&&(r+=e,e=0),r+=i.toString()):e++}),e>0&&(r+=e),r}).join("/");return n+=" "+this.activePlayer().charAt(0).toLowerCase(),n+=" "+this.castling,n+=" "+(this.enPassant?this.coordToString(this.enPassant):"-"),n+=" "+this.halfMoves+" "+this.fullMoves},"static fromFEN":function(t){t=t.trim();var n=this.FEN_REGEXP.exec(t);return o(!n,"Invalid FEN string '",t,"'!"),new this({board:this.boardFromFEN(n[1]),activePlayer:"w"===n[2]?"White":"Black",castling:"-"===n[3]?"":n[3],enPassant:"-"===n[4]?null:this.coordFromString(n[4]),halfMoves:+n[5],fullMoves:+n[6]})},"static FEN_REGEXP":/^((?:[pnbrqkPNBRQK12345678]+\/){7}[pnbrqkPNBRQK12345678]+)\s+([wb])\s+(-|[KQkq]+)\s+(-|[a-h][1-8])\s+(\d+)\s+(\d+)$/,"dual boardFromFEN":function(t){var n=t.split("/"),r={p:this.kinds.Pawn,n:this.kinds.Knight,b:this.kinds.Bishop,r:this.kinds.Rook,q:this.kinds.Queen,k:this.kinds.King},i=[];return n.forEach(function(t,n){var e=0;a(t).forEach(function(t){isNaN(t)?(i.push(new(r[t.toLowerCase()])(t===t.toLowerCase()?"Black":"White",[n,e])),e++):e+=0|t})}),new e.utils.CheckerboardFromPieces(8,8,i)},"static heuristics":{}}));l.initialBoard=l.prototype.initialBoard=function(){return l.boardFromFEN("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR")},e.games.Chess=l,l.__SERMAT__.identifier=h.__package__+"."+l.__SERMAT__.identifier,h.__SERMAT__.include.push(l),r.include(h);var p=i({constructor:function(t,n){this.player=t,this.position=n},moves:n.objects.unimplemented("Piece","moves(game, board)"),canMove:n.objects.unimplemented("Piece","canMove(game, board, position)"),moveTo:function(t){return new this.constructor(this.player,t)},next:function(t,n,r){return n.clone().__place__(r[1]).__place__(r[2],this.moveTo(r[2]))}}),f=l.kinds=l.prototype.kinds={};return f.Pawn=i(p,{name:"Pawn",moves:function(t,n){var r=this,e=this.player===t.players[0]?-1:1,i=[],o=[this.position[0]+e,this.position[1]];if(n.square(o)||i.push(o),[[e,-1],[e,1]].map(function(t){return[r.position[0]+t[0],r.position[1]+t[1]]}).forEach(function(t){if(n.isValidCoord(t)){var e=n.square(t);e&&e.player!==r.player&&i.push(t)}}),this.position[0]===(e>0?1:n.height-2)&&(o=[this.position[0]+2*e,this.position[1]],n.square(o)||i.push(o)),this.position[0]===(e<0?1:n.height-2)){var s=["Knight","Bishop","Rook","Queen"];return a(i).map(function(t){return s.map(function(n){return["promote",r.position,t,n]})}).flatten()}return a(i).map(function(t){return["move",r.position,t]})},next:function(t,n,r){return"move"===r[0]?p.prototype.next.call(this,t,n,r):n.clone().__place__(r[1]).__place__(r[2],new l.kinds[r[3]](this.player,r[2]))},toString:function(){return"White"===this.player?"P":"p"}}),f.Knight=i(p,{name:"Knight",DELTAS:[[2,1],[1,2],[2,-1],[-1,2],[-2,-1],[-1,-2],[-2,1],[1,-2]],moves:function(t,n){var r=this;return a(this.DELTAS).map(function(t){return["move",r.position,[r.position[0]+t[0],r.position[1]+t[1]]]},function(t){if(n.isValidCoord(t[2])){var e=n.square(t[2]);return!e||e.player!==r.player}return!1})},toString:function(){return"White"===this.player?"N":"n"}}),f.Bishop=i(p,{name:"Bishop",moves:function(t,n){var r=this;return a(n.walks(this.position,c.DIRECTIONS.DIAGONAL)).map(function(t){var e=!0;return t.tail().takeWhile(function(t){var i=n.square(t),o=e&&(!i||i.player!==r.player);return e=e&&!i,o}).map(function(t){return["move",r.position,t]})}).flatten()},next:function(t,n,r){return n.clone().__place__(r[1]).__place__(r[2],new this.constructor(this.player,r[2]))},toString:function(){return"White"===this.player?"B":"b"}}),f.Rook=i(p,{name:"Rook",moves:function(t,n){var r=this;return a(n.walks(this.position,c.DIRECTIONS.ORTHOGONAL)).map(function(t){var e=!0;return t.tail().takeWhile(function(t){var i=n.square(t),o=e&&(!i||i.player!==r.player);return e=e&&!i,o}).map(function(t){return["move",r.position,t]})}).flatten()},toString:function(){return"White"===this.player?"R":"r"}}),f.Queen=i(p,{name:"Queen",moves:function(t,n){var r=this;return a(n.walks(this.position,c.DIRECTIONS.EVERY)).map(function(t){var e=!0;return t.tail().takeWhile(function(t){var i=n.square(t),o=e&&(!i||i.player!==r.player);return e=e&&!i,o}).map(function(t){return["move",r.position,t]})}).flatten()},toString:function(){return"White"===this.player?"Q":"q"}}),f.King=i(p,{name:"King",moves:function(t,n){var r=this;return a(c.DIRECTIONS.EVERY).map(function(t){return["move",r.position,[r.position[0]+t[0],r.position[1]+t[1]]]},function(t){if(n.isValidCoord(t[2])){var e=n.square(t[2]);return!e||e.player!==r.player}return!1})},canMove:function(t,n,r){if(n.isValidCoord(r)&&1===Math.abs(this.position[0]-r[0])!=(1===Math.abs(this.position[1]-r[1]))){var e=n.square(r);return!e||e.player!==this.player}return!1},toString:function(){return"White"===this.player?"K":"k"}}),h});
//# sourceMappingURL=ludorum-game-chess.min.js.map